# futures_monitor.py ä»£ç è‡ªæŸ¥æŠ¥å‘Š

**è‡ªæŸ¥æ—¶é—´ï¼š** 2026-02-04
**æ£€æŸ¥äººå‘˜ï¼š** Claude Code
**æ£€æŸ¥èŒƒå›´ï¼š** futures_monitor.pyï¼ˆå¤šå“ç§ç›‘æ§ç³»ç»Ÿï¼‰

---

## ğŸ“‹ è‡ªæŸ¥æ€»ç»“

### âœ… æ•´ä½“è¯„ä¼°ï¼šè‰¯å¥½

ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œä¿¡å·ç”Ÿæˆé€»è¾‘æ­£ç¡®ï¼Œä½†å­˜åœ¨**1ä¸ªä¸¥é‡é—®é¢˜éœ€è¦ä¿®å¤**ã€‚

---

## âœ… æ­£ç¡®å®ç°çš„åŠŸèƒ½

### 1. å‚æ•°é…ç½® âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** TOP 10å“ç§çš„æœ€ä¼˜å‚æ•°æ˜¯å¦ä¸ä¼˜åŒ–ç»“æœä¸€è‡´

**ç»“æœï¼š** âœ… æ‰€æœ‰å‚æ•°å®Œå…¨æ­£ç¡®

| å“ç§ | EMA_FAST | EMA_SLOW | RSI_FILTER | RATIO_TRIGGER | STC_SELL_ZONE |
|------|----------|----------|------------|---------------|---------------|
| PTA | 12 | 10 | 40 | 1.25 | 75 âœ… |
| æ²ªé• | 3 | 20 | 55 | 1.10 | 75 âœ… |
| æ£•æ¦ˆæ²¹ | 12 | 10 | 45 | 1.20 | 75 âœ… |
| çº¯ç¢± | 12 | 20 | 35 | 1.05 | 75 âœ… |
| PVC | 3 | 25 | 55 | 1.05 | 75 âœ… |
| æ²ªé“œ | 3 | 20 | 35 | 1.05 | 75 âœ… |
| è±†ç²• | 12 | 20 | 35 | 1.25 | 75 âœ… |
| æ²ªé”¡ | 3 | 10 | 35 | 1.25 | 75 âœ… |
| æ²ªé“… | 12 | 10 | 40 | 1.05 | 75 âœ… |
| ç»ç’ƒ | 12 | 10 | 35 | 1.10 | 75 âœ… |

**éªŒè¯æ–¹æ³•ï¼š** å¯¹æ¯”ä¸­å›½æœŸè´§äº¤æ˜“çŸ¥è¯†åº“.mdä¸­çš„TOP 10å‚æ•°è¡¨æ ¼

---

### 2. äº¤æ˜“æ‰€ä»£ç  âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** å“ç§ä»£ç æ˜¯å¦ä¸AkShare APIå…¼å®¹

**æµ‹è¯•ç»“æœï¼š** æ‰€æœ‰10ä¸ªå“ç§å‡å¯æ­£å¸¸è·å–æ•°æ®

```
PTA (TA): OK âœ…
æ²ªé• (NI): OK âœ…
æ£•æ¦ˆæ²¹ (P): OK âœ…
çº¯ç¢± (SA): OK âœ…
PVC (V): OK âœ…
æ²ªé“œ (CU): OK âœ…
è±†ç²• (M): OK âœ…
æ²ªé”¡ (SN): OK âœ…
æ²ªé“… (PB): OK âœ…
ç»ç’ƒ (FG): OK âœ…
```

**éªŒè¯æ–¹æ³•ï¼š** å®é™…è°ƒç”¨ ChinaFuturesFetcher.get_historical_data()

---

### 3. ä¿¡å·ç”Ÿæˆé€»è¾‘ âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** ä¹°å…¥/å–å‡ºä¿¡å·é€»è¾‘æ˜¯å¦ä¸å›æµ‹ä»£ç ä¸€è‡´

**ç»“æœï¼š** âœ… 100%ä¸€è‡´

#### ä¹°å…¥ä¿¡å·ï¼ˆç¬¬336-349è¡Œï¼‰

```python
# ç‹™å‡»ä¿¡å·ï¼ˆ5ä¸ªæ¡ä»¶ï¼‰
trend_up = latest['ema_fast'] > latest['ema_slow']
ratio_safe = (0 < latest['ratio'] < params['RATIO_TRIGGER'])
ratio_shrinking = latest['ratio'] < prev['ratio']
turning_up = latest['macd_dif'] > prev['macd_dif']
is_strong = latest['rsi'] > params['RSI_FILTER']

sniper_signal = trend_up and ratio_safe and ratio_shrinking and turning_up and is_strong

# è¿½æ¶¨ä¿¡å·ï¼ˆ2ä¸ªæ¡ä»¶ï¼‰
ema_cross = (prev['ema_fast'] <= prev['ema_slow']) and (latest['ema_fast'] > latest['ema_slow'])
chase_signal = ema_cross and is_strong

buy_signal = sniper_signal or chase_signal
```

**å¯¹æ¯”ç»“æœï¼š** ä¸å›æµ‹ä»£ç ï¼ˆreoptimize_realistic.pyç­‰ï¼‰å®Œå…¨ä¸€è‡´ âœ…

#### å–å‡ºä¿¡å·ï¼ˆç¬¬351-355è¡Œï¼‰

```python
# STCæ­¢ç›ˆ
stc_exit = (df['stc_prev'].iloc[-1] > params['STC_SELL_ZONE']) and (latest['stc'] < df['stc_prev'].iloc[-1])

# è¶‹åŠ¿åè½¬
trend_exit = latest['ema_fast'] < latest['ema_slow']

sell_signal = stc_exit or trend_exit
```

**å¯¹æ¯”ç»“æœï¼š** ä¸å›æµ‹ä»£ç å®Œå…¨ä¸€è‡´ âœ…

---

### 4. æ•°æ®è·å–é€»è¾‘ âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** æ˜¯å¦ä½¿ç”¨å®æ—¶æ•°æ®æºï¼Œæ˜¯å¦æœ‰å¤‡ç”¨æœºåˆ¶

**å®ç°ï¼š** ï¼ˆç¬¬520-555è¡Œï¼‰

```python
def load_market_data(future_name: str, future_code: str):
    # 1. ä¼˜å…ˆä½¿ç”¨AkShare APIï¼ˆå®æ—¶æ•°æ®ï¼‰
    df = fetcher.get_historical_data(future_code, days=HISTORICAL_DAYS)

    if df is not None and not df.empty:
        return df, 'API'

    # 2. APIå¤±è´¥ï¼Œä½¿ç”¨CSVå¤‡ç”¨
    csv_files = list(BACKUP_DATA_DIR.glob(f'*{future_name}*.csv'))
    if csv_files:
        df = pd.read_csv(csv_path)
        return df, 'CSV'

    return None, None
```

**éªŒè¯ç»“æœï¼š**
- âœ… ä¼˜å…ˆä½¿ç”¨AkShare APIï¼ˆå®æ—¶æ•°æ®ï¼‰
- âœ… APIå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢CSVå¤‡ç”¨
- âœ… ä¸äº‘ç«¯é“œç›‘æ§ç¨‹åºä½¿ç”¨ç›¸åŒæ•°æ®æº
- âœ… è¿”å›æ•°æ®æºæ ‡è¯†ï¼Œä¾¿äºè¿½è¸ª

---

### 5. å®šæ—¶è¿è¡Œé€»è¾‘ âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** æ˜¯å¦æŒ‰4å°æ—¶æ•´ç‚¹è¿è¡Œï¼ˆ0:00, 4:00, 8:00, 12:00, 16:00, 20:00ï¼‰

**å®ç°ï¼š** ï¼ˆç¬¬801-819è¡Œï¼‰

```python
def get_wait_seconds():
    """è®¡ç®—åˆ°ä¸‹ä¸€ä¸ª4å°æ—¶æ•´ç‚¹çš„ç­‰å¾…æ—¶é—´"""
    now = datetime.now()
    hour = now.hour

    # è®¡ç®—4å°æ—¶æ•´ç‚¹
    next_hour = ((hour // RUN_INTERVAL_HOURS) + 1) * RUN_INTERVAL_HOURS
    if next_hour >= 24:
        next_hour = 0

    next_time = now.replace(hour=next_hour, minute=0, second=0, microsecond=0)

    if next_hour == 0:
        next_time += timedelta(days=1)

    wait_seconds = (next_time - now).total_seconds()
    return wait_seconds, next_time
```

**éªŒè¯ç»“æœï¼š**
- âœ… æ­£ç¡®è®¡ç®—ä¸‹ä¸€ä¸ª4å°æ—¶æ•´ç‚¹
- âœ… å¤„ç†è·¨æ—¥æƒ…å†µï¼ˆ23:00åæ¬¡æ—¥0:00ï¼‰
- âœ… åˆ†æ®µç­‰å¾…ï¼Œæ¯60ç§’æ£€æŸ¥é€€å‡ºä¿¡å·ï¼ˆç¬¬851-858è¡Œï¼‰
- âœ… å¯åŠ¨æ—¶ç«‹å³è¿è¡Œä¸€æ¬¡ï¼ˆç¬¬833è¡Œï¼‰

---

### 6. æŒä»“ç®¡ç† âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** æ˜¯å¦ç‹¬ç«‹ç®¡ç†æ¯ä¸ªå“ç§çš„æŒä»“

**å®ç°ï¼š** ï¼ˆç¬¬392-415è¡Œï¼‰

```python
def load_all_positions() -> Dict:
    """åŠ è½½æ‰€æœ‰å“ç§çš„æŒä»“çŠ¶æ€"""
    return {
        future_name: {
            'holding': False,
            'entry_price': None,
            'entry_datetime': None,
            'stop_loss': None,
            'signal_id': None
        }
        for future_name in TOP10_FUTURES_CONFIG.keys()
    }
```

**éªŒè¯ç»“æœï¼š**
- âœ… æ¯ä¸ªå“ç§ç‹¬ç«‹æŒä»“çŠ¶æ€
- âœ… JSONæŒä¹…åŒ–å­˜å‚¨ï¼ˆmulti_positions.jsonï¼‰
- âœ… æ”¯æŒæŸåæ–‡ä»¶è‡ªåŠ¨å¤‡ä»½
- âœ… ä¸è®°å½•å…·ä½“é‡‘é¢ï¼Œåªè®°å½•æŒä»“çŠ¶æ€

---

### 7. ä¿¡å·æ¨é€ âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** æ˜¯å¦æ¨é€å½“å‰ä¿¡å·å’Œäº¤æ˜“æé†’

**å®ç°ï¼š** ï¼ˆç¬¬737-794è¡Œï¼‰

```python
def send_telegram_report(all_signals, positions, buy_signals, sell_signals, active_positions):
    # æŠ¥å‘Šå†…å®¹ï¼š
    # 1. ç›‘æ§å“ç§æ•°
    # 2. å½“å‰æŒä»“æ•°
    # 3. ä¹°å…¥ä¿¡å·åˆ—è¡¨ï¼ˆå“ç§+ç±»å‹+ä»·æ ¼ï¼‰
    # 4. å–å‡ºä¿¡å·åˆ—è¡¨ï¼ˆå“ç§+ç±»å‹+ä»·æ ¼ï¼‰
    # 5. å„å“ç§çŠ¶æ€æ‘˜è¦
```

**éªŒè¯ç»“æœï¼š**
- âœ… æ¨é€ç›‘æ§æ±‡æ€»ä¿¡æ¯
- âœ… é«˜äº®ä¹°å…¥/å–å‡ºä¿¡å·
- âœ… æ˜¾ç¤ºå„å“ç§å½“å‰çŠ¶æ€
- âœ… å¤±è´¥ä¸å½±å“ç¨‹åºè¿è¡Œï¼ˆç¬¬724è¡Œï¼‰

---

### 8. ä¼˜é›…é€€å‡º âœ… å®Œå…¨æ­£ç¡®

**æ£€æŸ¥é¡¹ï¼š** æ˜¯å¦æ”¯æŒå®¹å™¨ç¯å¢ƒçš„ä¼˜é›…é€€å‡º

**å®ç°ï¼š** ï¼ˆç¬¬44-56è¡Œï¼‰

```python
shutdown_requested = False

def signal_handler(signum, frame):
    global shutdown_requested
    logger.info(f"\næ”¶åˆ°é€€å‡ºä¿¡å· {signum}ï¼Œå‡†å¤‡ä¼˜é›…é€€å‡º...")
    shutdown_requested = True

signal.signal(signal.SIGTERM, signal_handler)
signal.signal(signal.SIGINT, signal_handler)
```

**éªŒè¯ç»“æœï¼š**
- âœ… æ³¨å†ŒSIGTERMå’ŒSIGINTå¤„ç†å™¨
- âœ… åˆ†æ®µç­‰å¾…ä¸­æ£€æŸ¥é€€å‡ºæ ‡å¿—ï¼ˆç¬¬852è¡Œï¼‰
- âœ… é€€å‡ºæ—¶æ‰“å°æ—¥å¿—ï¼ˆç¬¬867-869è¡Œï¼‰
- âœ… é€‚åˆZeaburå®¹å™¨éƒ¨ç½²

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### ğŸ”´ é—®é¢˜1ï¼šæ­¢æŸæ£€æŸ¥ä½¿ç”¨æ”¶ç›˜ä»·è€Œéæœ€ä½ä»·ï¼ˆä¸¥é‡ï¼‰

**é—®é¢˜æè¿°ï¼š**

å½“å‰æ­¢æŸæ£€æŸ¥ä½¿ç”¨çš„æ˜¯**æ”¶ç›˜ä»·**ï¼ˆ`close`ï¼‰ï¼Œè€Œä¸æ˜¯**æœ€ä½ä»·**ï¼ˆ`low`ï¼‰ï¼Œè¿™ä¸å›æµ‹ä»£ç çš„é€»è¾‘ä¸ä¸€è‡´ã€‚

**é—®é¢˜ä½ç½®ï¼š** `futures_monitor.py:615`

```python
# å½“å‰ä»£ç ï¼ˆé”™è¯¯ï¼‰
if signal['price'] <= position['stop_loss']:  # signal['price'] æ˜¯æ”¶ç›˜ä»·
    logger.warning(f"[{future_name}] æ­¢æŸè§¦å‘! ä»·æ ¼ {signal['price']:.2f} <= æ­¢æŸ {position['stop_loss']:.2f}")
    signal['sell_signal'] = True
```

**é—®é¢˜å½±å“ï¼š**

1. **åº”è¯¥æ­¢æŸæ—¶å¯èƒ½ä¸è§¦å‘**
   - å‡è®¾æ­¢æŸä»· = 100
   - Kçº¿æœ€ä½ä»· = 99ï¼ˆè§¦åŠæ­¢æŸï¼‰
   - Kçº¿æ”¶ç›˜ä»· = 101ï¼ˆåå¼¹ï¼‰
   - å½“å‰é€»è¾‘ï¼šä¸è§¦å‘æ­¢æŸ âŒ
   - æ­£ç¡®é€»è¾‘ï¼šåº”è¯¥è§¦å‘æ­¢æŸ âœ…

2. **ä¸å›æµ‹ç»“æœä¸ä¸€è‡´**
   - å›æµ‹ä½¿ç”¨æœ€ä½ä»·æ£€æŸ¥æ­¢æŸ
   - å®ç›˜ä½¿ç”¨æ”¶ç›˜ä»·æ£€æŸ¥æ­¢æŸ
   - å¯¼è‡´å®ç›˜é£é™©å¤§äºå›æµ‹

**å›æµ‹ä»£ç çš„æ­£ç¡®åšæ³•ï¼š**

æ‰€æœ‰å›æµ‹ä»£ç ï¼ˆreoptimize_realistic.py, backtest_all_futures.pyç­‰27ä¸ªæ–‡ä»¶ï¼‰éƒ½ä½¿ç”¨ï¼š

```python
# æ­£ç¡®åšæ³•
if df['low'].iloc[i] <= position['stop_loss']:
    exit_price = position['stop_loss']
    exit_reason = 'æ­¢æŸ'
```

**ä¿®å¤æ–¹æ¡ˆï¼š**

1. **åœ¨ `check_signals` å‡½æ•°ä¸­æ·»åŠ  `low` ä»·æ ¼åˆ°è¿”å›å­—å…¸**ï¼ˆç¬¬360è¡Œé™„è¿‘ï¼‰ï¼š

```python
return {
    'future': future_name,
    'datetime': str(latest['datetime']),
    'price': float(latest['close']),
    'low': float(latest['low']),  # â­ æ·»åŠ è¿™è¡Œ
    'indicators': {
        # ...
    },
    # ...
}
```

2. **åœ¨ `monitor_single_future` å‡½æ•°ä¸­ä½¿ç”¨ `low` ä»·æ ¼æ£€æŸ¥æ­¢æŸ**ï¼ˆç¬¬615è¡Œï¼‰ï¼š

```python
# ä¿®å¤å
if signal['low'] <= position['stop_loss']:  # â­ ä½¿ç”¨ low è€Œä¸æ˜¯ price
    logger.warning(f"[{future_name}] æ­¢æŸè§¦å‘! æœ€ä½ä»· {signal['low']:.2f} <= æ­¢æŸ {position['stop_loss']:.2f}")
    signal['sell_signal'] = True
    signal['signal_type'] = 'stop_loss'
    signal['reason']['sell'] = 'stop_loss'
    # æ­¢æŸæ—¶å‡ºåœºä»·æ ¼ä½¿ç”¨æ­¢æŸä»·
    signal['price'] = position['stop_loss']  # â­ ä¿®æ­£å‡ºåœºä»·æ ¼ä¸ºæ­¢æŸä»·
```

**éªŒè¯æ•°æ®å¯ç”¨æ€§ï¼š**

å·²ç¡®è®¤ `china_futures_fetcher.py` è¿”å›çš„æ•°æ®åŒ…å« `low` å­—æ®µï¼š

```python
# china_futures_fetcher.py:134
'low': 'min',
```

---

## ğŸ“Š é—®é¢˜ä¸¥é‡æ€§è¯„ä¼°

| é—®é¢˜ | ä¸¥é‡æ€§ | å½±å“èŒƒå›´ | æ˜¯å¦é˜»å¡éƒ¨ç½² |
|------|--------|----------|-------------|
| æ­¢æŸä½¿ç”¨æ”¶ç›˜ä»· | ğŸ”´ ä¸¥é‡ | é£é™©æ§åˆ¶ | **æ˜¯** |

**å»ºè®®ï¼š** åœ¨éƒ¨ç½²åˆ°Zeaburå‰ï¼Œ**å¿…é¡»ä¿®å¤æ­¢æŸé—®é¢˜**ã€‚

---

## âœ… ç¬¦åˆç”¨æˆ·éœ€æ±‚

| éœ€æ±‚ | å®ç°çŠ¶æ€ | ä»£ç ä½ç½® |
|------|---------|---------|
| ç›‘æ§10ä¸ªå“ç§ | âœ… | TOP10_FUTURES_CONFIGï¼ˆç¬¬62-223è¡Œï¼‰ |
| æ¯ä¸ªå“ç§ç‹¬ç«‹å‚æ•° | âœ… | paramså­—å…¸åµŒå¥—åœ¨configä¸­ |
| æ¯4å°æ—¶è¿è¡Œ | âœ… | get_wait_seconds()ï¼ˆç¬¬801è¡Œï¼‰ |
| æ¨é€å½“å‰ä¿¡å· | âœ… | send_telegram_report()ï¼ˆç¬¬737è¡Œï¼‰ |
| äº¤æ˜“ä¿¡å·æé†’ | âœ… | Telegramæ¨é€ + æ—¥å¿—é«˜äº® |
| è®°å½•æŒä»“ï¼ˆæ— é‡‘é¢ï¼‰ | âœ… | multi_positions.jsonï¼ˆç¬¬445è¡Œï¼‰ |
| å®æ—¶æ•°æ®æº | âœ… | AkShare APIï¼ˆç¬¬529è¡Œï¼‰ |

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### P0 - å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡éƒ¨ç½²ï¼‰

1. **æ­¢æŸæ£€æŸ¥ä½¿ç”¨æœ€ä½ä»·è€Œéæ”¶ç›˜ä»·**
   - æ–‡ä»¶ï¼š`futures_monitor.py`
   - è¡Œæ•°ï¼š360, 615-620
   - å·¥ä½œé‡ï¼š5åˆ†é’Ÿ

---

## ğŸ“ è‡ªæŸ¥ç»“è®º

### æ€»ä½“è¯„ä»·ï¼šâ­â­â­â­â˜†ï¼ˆ4/5æ˜Ÿï¼‰

**ä¼˜ç‚¹ï¼š**
1. âœ… å‚æ•°é…ç½®å®Œå…¨æ­£ç¡®ï¼Œä¸ä¼˜åŒ–ç»“æœä¸€è‡´
2. âœ… ä¿¡å·ç”Ÿæˆé€»è¾‘ä¸å›æµ‹ä»£ç 100%ä¸€è‡´
3. âœ… æ•°æ®è·å–æœºåˆ¶å®Œå–„ï¼ˆAPI + CSVå¤‡ç”¨ï¼‰
4. âœ… å®šæ—¶è¿è¡Œé€»è¾‘æ­£ç¡®ï¼ˆ4å°æ—¶æ•´ç‚¹ï¼‰
5. âœ… æŒä»“ç®¡ç†æ¸…æ™°ç‹¬ç«‹
6. âœ… é€‚åˆZeaburå®¹å™¨éƒ¨ç½²ï¼ˆä¼˜é›…é€€å‡ºï¼‰

**ç¼ºç‚¹ï¼š**
1. âš ï¸ æ­¢æŸæ£€æŸ¥ä½¿ç”¨æ”¶ç›˜ä»·ï¼Œä¸å›æµ‹ä¸ä¸€è‡´ï¼Œå­˜åœ¨é£é™©

**å»ºè®®ï¼š**
- ä¿®å¤æ­¢æŸé—®é¢˜åå³å¯éƒ¨ç½²
- å…¶ä»–åŠŸèƒ½æ— éœ€ä¿®æ”¹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨

---

## ğŸ”§ ä¿®å¤åçš„éƒ¨ç½²æ¸…å•

- [ ] ä¿®å¤æ­¢æŸæ£€æŸ¥é€»è¾‘ï¼ˆä½¿ç”¨`low`è€Œé`close`ï¼‰
- [ ] æœ¬åœ°æµ‹è¯•æ­¢æŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸
- [ ] æäº¤ä¿®å¤åˆ°Git
- [ ] æ¨é€åˆ°GitHub
- [ ] åœ¨Zeaburåˆ›å»ºæœåŠ¡
- [ ] é…ç½®æŒä¹…åŒ–å­˜å‚¨ï¼ˆ/app/logsï¼‰
- [ ] é…ç½®Telegramç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
- [ ] å¯åŠ¨æœåŠ¡å¹¶éªŒè¯

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2026-02-04
**æ£€æŸ¥çŠ¶æ€ï¼š** âœ… è‡ªæŸ¥å®Œæˆï¼Œå‘ç°1ä¸ªä¸¥é‡é—®é¢˜
**ä¸‹ä¸€æ­¥ï¼š** ä¿®å¤æ­¢æŸé—®é¢˜åå³å¯éƒ¨ç½²
