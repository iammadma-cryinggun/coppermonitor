//@version=5
indicator("æ—¥çº¿è¶‹åŠ¿åˆ¤æ–­+4å°æ—¶å…¥åœº", overlay=true, max_boxes_count=50, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥å‚æ•°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ—¥çº¿æ•°æ®å‚æ•°
ema_fast = input.int(3, "æ—¥çº¿EMAå¿«çº¿å‘¨æœŸ", minval=1, maxval=50, group="æ—¥çº¿å‚æ•°")
ema_slow = input.int(15, "æ—¥çº¿EMAæ…¢çº¿å‘¨æœŸ", minval=1, maxval=100, group="æ—¥çº¿å‚æ•°")
adx_period = input.int(14, "ADXå‘¨æœŸ", minval=1, maxval=50, group="æ—¥çº¿å‚æ•°")
lookback_days = input.int(10, "ä»·æ ¼ä½ç½®å›çœ‹å¤©æ•°", minval=5, maxval=30, group="æ—¥çº¿å‚æ•°")

// 4å°æ—¶æ•°æ®å‚æ•°
he_4h_fast = input.int(3, "4H EMAå¿«çº¿å‘¨æœŸ", minval=1, maxval=20, group="4Hå‚æ•°")
he_4h_slow = input.int(15, "4H EMAæ…¢çº¿å‘¨æœŸ", minval=1, maxval=50, group="4Hå‚æ•°")
rsi_4h_period = input.int(14, "4H RSIå‘¨æœŸ", minval=1, maxval=30, group="4Hå‚æ•°")
rsi_4h_oversold = input.int(30, "4H RSIè¶…å–é˜ˆå€¼", minval=10, maxval=40, group="4Hå‚æ•°")

// æ˜¾ç¤ºé€‰é¡¹
show_background = input.bool(true, "æ˜¾ç¤ºèƒŒæ™¯è‰²æ ‡è¯†å¸‚åœºçŠ¶æ€", group="æ˜¾ç¤ºé€‰é¡¹")
show_labels = input.bool(true, "æ˜¾ç¤ºæ–‡å­—æ ‡ç­¾", group="æ˜¾ç¤ºé€‰é¡¹")
show_signals = input.bool(true, "æ˜¾ç¤ºäº¤æ˜“ä¿¡å·", group="æ˜¾ç¤ºé€‰é¡¹")

// é¢œè‰²è®¾ç½®
color_uptrend = input.color(color.new(color.green, 90), "ä¸Šæ¶¨è¶‹åŠ¿èƒŒæ™¯è‰²", group="é¢œè‰²è®¾ç½®")
color_downtrend = input.color(color.new(color.red, 90), "ä¸‹è·Œè¶‹åŠ¿èƒŒæ™¯è‰²", group="é¢œè‰²è®¾ç½®")
color_ranging = input.color(color.new(color.yellow, 90), "éœ‡è¡å¸‚èƒŒæ™¯è‰²", group="é¢œè‰²è®¾ç½®")
color_signal = input.color(color.white, "ä¿¡å·æ–‡å­—é¢œè‰²", group="é¢œè‰²è®¾ç½®")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è·å–æ—¥çº¿æ•°æ®
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// è·å–æ—¥çº¿EMA
ema_fast_daily = ta.ema(close, ema_fast)
ema_slow_daily = ta.ema(close, ema_slow)

// è®¡ç®—ADX
[di_plus, di_minus, adx_value] = ta.dmi(adx_period, adx_period)
adx_line = ta.sma(adx_value, adx_period)

// è®¡ç®—è¶‹åŠ¿æ–¹å‘
trend_up = ema_fast_daily > ema_slow_daily
trend_down = ema_fast_daily < ema_slow_daily

// è®¡ç®—å…¥åœºå‰æ¶¨å¹…
var float change_before_pct = 0.0
if bar_index >= lookback_days and bar_index >= 1
    change_before_pct := (close - close[lookback_days]) / close[lookback_days] * 100

// è®¡ç®—ä»·æ ¼ä½ç½®ï¼ˆç›¸å¯¹äºæœ€è¿‘Nå¤©çš„é«˜ä½ç‚¹ï¼‰
float highest = ta.highest(high, lookback_days)
float lowest = ta.lowest(low, lookback_days)
float price_position = (close - lowest) / (highest - lowest) * 100

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆ¤æ–­å¸‚åœºçŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å¸‚åœºçŠ¶æ€åˆ¤æ–­
is_uptrend_ok = trend_up and adx_line >= 25 and di_plus > di_minus  // é¡ºåŠ¿ï¼šè¶‹åŠ¿å‘ä¸Šä¸”å¼ºåº¦è¶³å¤Ÿ
is_uptrend_weak = trend_up and (adx_line < 25 or di_plus <= di_minus)  // å¼±åŠ¿å‘ä¸Šï¼šè¶‹åŠ¿å‘ä¸Šä½†å¼ºåº¦ä¸è¶³
is_downtrend = trend_down  // ä¸‹è·Œè¶‹åŠ¿
is_ranging = not trend_up and not trend_down  // æ¨ªç›˜

// å±é™©ä¿¡å·ï¼ˆé€†åŠ¿äº¤æ˜“ï¼‰
is_chase_high = change_before_pct > 1.0  // è¿½é«˜
is_high_position = price_position > 80  // é«˜ä½æ¥ç›˜
is_low_adx = adx_line < 20  // æ— è¶‹åŠ¿

// ç»¼åˆåˆ¤æ–­
market_state = ""
bg_color = color.white

if is_uptrend_ok and not is_chase_high and not is_high_position
    market_state := "ã€é¡ºåŠ¿åšå¤šã€‘"
    bg_color := color.new(color.green, 90)  // ç»¿è‰²åŠé€æ˜
else if is_downtrend
    market_state := "ã€ä¸‹è·Œè¶‹åŠ¿ã€‘"
    bg_color := color.new(color.red, 90)  // çº¢è‰²åŠé€æ˜
else if is_uptrend_weak
    market_state := "ã€å¼±ä¸Šæ¶¨ã€‘"
    bg_color := color.new(color.yellow, 90)  // é»„è‰²åŠé€æ˜
else if is_ranging
    market_state := "ã€æ¨ªç›˜éœ‡è¡ã€‘"
    bg_color := color.new(color.gray, 90)  // ç°è‰²åŠé€æ˜
else
    market_state := "ã€è§‚å¯Ÿã€‘"
    bg_color := color.white

// å±é™©è­¦å‘Š
danger_warning = ""
if is_chase_high
    danger_warning := danger_warning + "âš ï¸ è¿½é«˜ï¼"
if is_high_position
    danger_warning := danger_warning + "âš ï¸ é«˜ä½ï¼"
if is_low_adx
    danger_warning := danger_warning + "âš ï¸ æ— è¶‹åŠ¿ï¼"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç»˜åˆ¶æ—¥çº¿è¶‹åŠ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(ema_fast_daily, color=color.new(color.blue, 0), linewidth=2, title="æ—¥çº¿EMA" + str.tostring(ema_fast))
plot(ema_slow_daily, color=color.new(color.red, 0), linewidth=2, title="æ—¥çº¿EMA" + str.tostring(ema_slow))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç»˜åˆ¶èƒŒæ™¯è‰²æ ‡è¯†å¸‚åœºçŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_background
    bgcolor(bg_color, title="å¸‚åœºçŠ¶æ€")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç»˜åˆ¶ä¿¡æ¯é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_labels
    var table info_table = table.new(position.top_right, 2, 15, bgcolor=color.new(color.white, 20), border_width=1)

    // æ ‡é¢˜è¡Œ
    table.cell(info_table, 0, 0, "ğŸ“Š æ—¥çº¿è¶‹åŠ¿çŠ¶æ€", text_color=color.white, text_size=size.normal, bgcolor=color.blue)
    table.cell(info_table, 0, 1, "", bgcolor=color.blue)

    // EMAè¶‹åŠ¿
    trend_text = trend_up ? "â†‘ ä¸Šæ¶¨" : (trend_down ? "â†“ ä¸‹è·Œ" : "- æ¨ªç›˜")
    trend_color = trend_up ? color.green : (trend_down ? color.red : color.gray)
    table.cell(info_table, 1, 0, "EMAè¶‹åŠ¿", text_color=color.black)
    table.cell(info_table, 1, 1, trend_text, text_color=trend_color, text_size=size.large)

    // ADXå¼ºåº¦
    adx_text = adx_line >= 25 ? "å¼º" : (adx_line >= 20 ? "ä¸­" : "å¼±")
    table.cell(info_table, 2, 0, "ADXå¼ºåº¦", text_color=color.black)
    table.cell(info_table, 2, 1, str.tostring(adx_line, format.mint) + " (" + adx_text + ")", text_color=color.black)

    // è¶‹åŠ¿æ–¹å‘
    direction_text = di_plus > di_minus ? "+DI â†‘" : "-DI â†“"
    table.cell(info_table, 3, 0, "æ–¹å‘", text_color=color.black)
    table.cell(info_table, 3, 1, direction_text, text_color=color.black)

    // å¸‚åœºçŠ¶æ€
    table.cell(info_table, 4, 0, "å¸‚åœºçŠ¶æ€", text_color=color.black, bgcolor=color.new(color.gray, 20))
    table.cell(info_table, 4, 1, market_state, text_color=color.black, text_size=size.normal)

    // å…¥åœºå‰æ¶¨å¹…
    table.cell(info_table, 5, 0, "å…¥åœºå‰æ¶¨å¹…", text_color=color.black)
    change_color = change_before_pct > 1 ? color.red : (change_before_pct < 0 ? color.green : color.black)
    table.cell(info_table, 5, 1, str.tostring(change_before_pct, format.percent) + " (" + str.tostring(lookback_days) + "å¤©)", text_color=change_color)

    // ä»·æ ¼ä½ç½®
    table.cell(info_table, 6, 0, "ä»·æ ¼ä½ç½®", text_color=color.black)
    position_color = price_position > 80 ? color.red : (price_position < 20 ? color.green : color.black)
    table.cell(info_table, 6, 1, str.tostring(price_position, format.percent), text_color=position_color)

    // å±é™©è­¦å‘Š
    if danger_warning != ""
        table.cell(info_table, 7, 0, "âš ï¸ è­¦å‘Š", text_color=color.white, bgcolor=color.red)
        table.cell(info_table, 7, 1, danger_warning, text_color=color.yellow, text_size=size.normal)

    // åšå¤šä¿¡å·
    bgcolor_signal = is_uptrend_ok and not is_chase_high and not is_high_position ? color.new(color.green, 0) : color.new(color.gray, 0)
    signal_text = is_uptrend_ok and not is_chase_high and not is_high_position ? "âœ… å¯ä»¥åšå¤š" : "âŒ ç¦æ­¢åšå¤š"

    table.cell(info_table, 8, 0, "åšå¤šä¿¡å·", text_color=color.white, bgcolor=color.blue)
    table.cell(info_table, 8, 1, signal_text, text_color=color_signal, text_size=size.large)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç»˜åˆ¶åšå¤šä¿¡å·ç®­å¤´
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_signals
    // å½“æ»¡è¶³é¡ºåŠ¿åšå¤šæ¡ä»¶æ—¶ï¼Œåœ¨Kçº¿ä¸‹æ–¹æ˜¾ç¤ºç®­å¤´
    if is_uptrend_ok and not is_chase_high and not is_high_position
        label.new(bar_index, low, "â–² é¡ºåŠ¿åšå¤š", style=label.style_label_down, color=color.new(color.green, 0),
                 textcolor=color.white, size=size.small)

    // å½“å‡ºç°å±é™©ä¿¡å·æ—¶ï¼Œæ˜¾ç¤ºè­¦å‘Š
    if danger_warning != ""
        label.new(bar_index, high, danger_warning, style=label.style_label_down, color=color.red,
                 textcolor=color.yellow, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4å°æ—¶å…¥åœºæç¤ºï¼ˆåœ¨ä¿¡æ¯æ ä¸­ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

string tooltip_4h = "ã€4å°æ—¶å…¥åœºè¦ç‚¹ã€‘\n"
tooltip_4h := tooltip_4h + "å½“æ—¥çº¿æ»¡è¶³é¡ºåŠ¿æ¡ä»¶æ—¶ï¼š\n"
tooltip_4h := tooltip_4h + "1. ç­‰å¾…4å°æ—¶EMA(3)ä¸Šç©¿EMA(15)\n"
tooltip_4h := tooltip_4h + "2. æˆ–è€…4å°æ—¶RSI < " + str.tostring(rsi_4h_oversold) + "ï¼ˆè¶…å–å›è°ƒï¼‰\n"
tooltip_4h := tooltip_4h + "3. ä¸¥æ ¼2%æ­¢æŸ"

if show_labels
    var table_4h = table.new(position.bottom_left, 2, 10, bgcolor=color.new(color.white, 20), border_width=1)
    table_4h.cell(0, 0, "4å°æ—¶å…¥åœº", text_color=color.white, bgcolor=color.new(color.blue, 0))
    table_4h.cell(0, 1, tooltip_4h, text_color=color.white)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æŠ¥è­¦æç¤º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å½“å±é™©ä¿¡å·å‡ºç°æ—¶ï¼Œé—ªçƒè­¦æŠ¥
if danger_warning != ""
    alert("å±é™©è­¦å‘Šï¼š" + danger_warning)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¿¡å·æ€»ç»“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plotchar(is_uptrend_ok and not is_chase_high and not is_high_position ? "â–²" : "",
     location=location.top_right, color=color.green, size=size.large, title="é¡ºåŠ¿åšå¤šä¿¡å·", char=char.triangleup)

plotchar(danger_warning != "" ? "âš " : "",
     location=location.top_right, color=color.red, size=size.large, offset=1, title="å±é™©è­¦å‘Š", char=char.warning)

// EOF
