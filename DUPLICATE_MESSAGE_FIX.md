# Telegram推送重复消息问题修复

**问题：** 16:00和20:00推送的信息完全一样

**修复时间：** 2026-02-04 22:05

---

## 问题原因

### 1. 缓存时间过长
**缓存设置：** 15分钟
```python
self._cache_ttl = timedelta(minutes=15)
```

**问题：** 如果数据源更新延迟，15分钟缓存可能导致两次运行获取到相同的数据。

### 2. 时间显示不精确
**原格式：** `2026-02-04 16:00`（只显示到小时）
```python
f"🕐 时间: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
```

**问题：**
- 如果16:05运行，显示"16:00"
- 如果20:05运行，显示"20:00"
- 用户无法区分是整点运行还是其他时间运行

### 3. 各品种状态没有显示价格
**原格式：** 只显示状态，没有价格
```
纯碱: 📈 强势
```

**问题：** 用户无法看到各个品种的实际价格

---

## 修复方案

### 1. 缩短缓存时间

**文件：** `china_futures_fetcher.py`

**修改：**
```python
# 修改前
self._cache_ttl = timedelta(minutes=15)

# 修改后
self._cache_ttl = timedelta(minutes=5)
```

**效果：** 缓存时间从15分钟缩短到5分钟，确保获取更新鲜的数据。

### 2. 显示完整时间

**文件：** `futures_monitor.py`

**修改：**
```python
# 修改前
f"🕐 时间: {datetime.now().strftime('%Y-%m-%d %H:%M')}"

# 修改后
f"🕐 时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
```

**效果：** 显示完整的时分秒，用户可以清楚知道运行的确切时间。

**对比：**
- 修改前：`2026-02-04 16:00`（整点运行还是其他时间不清楚）
- 修改后：`2026-02-04 16:05:32`（精确到秒）

### 3. 各品种状态添加价格显示

**文件：** `futures_monitor.py`

**修改：**
```python
# 修改前
status = f"📈 强势"
report_lines.append(f"   {future_name}: {status}")

# 修改后
price_str = f"{price:.0f}" if price > 0 else "N/A"
status = f"📈 {price_str} | 强势"
report_lines.append(f"   {future_name}: {status}")
```

**效果：** 每个品种都显示当前价格。

**对比：**
- 修改前：`纯碱: 📈 强势`
- 修改后：`纯碱: 📈 1217 | 强势`

---

## 修复后的效果

### 修复前
```
📊 期货多品种监控报告
🕐 时间: 2026-02-04 16:00

📋 各品种状态:
   纯碱: 📈 强势
   PTA: 📉 中等
   棕榈油: 📈 强势
```

### 修复后
```
📊 期货多品种监控报告
🕐 时间: 2026-02-04 16:05:32

📋 各品种状态:
   纯碱: 📈 1217 | 强势
   PTA: 📉 5218 | 中等
   棕榈油: 📈 9105 | 强势
```

**用户可以清楚看到：**
1. 精确的运行时间（16:05:32）
2. 每个品种的当前价格
3. 如果16:00和20:00的价格不同，消息内容会明显不同

---

## 其他建议

### 1. 添加数据时间戳（可选）

如果仍然遇到重复数据，可以在消息中添加数据源时间戳：

```
📊 期货多品种监控报告
🕐 报告时间: 2026-02-04 16:05:32
📡 数据时间: 2026-02-04 16:00
```

这样用户可以知道数据是什么时候的。

### 2. 完全禁用缓存（可选）

如果数据源稳定，可以考虑禁用缓存：

```python
# 禁用缓存
self._cache_ttl = timedelta(seconds=0)
```

### 3. 添加数据变化检测（可选）

可以在报告中添加数据变化提示：

```
✅ 数据已更新 (上次: 16:00:00, 本次: 20:00:00)
```

---

## 文件修改清单

**修改的文件：**
1. ✅ `china_futures_fetcher.py` - 缩短缓存时间到5分钟
2. ✅ `futures_monitor.py` - 显示完整时间（包含秒）
3. ✅ `futures_monitor.py` - 各品种状态添加价格显示

---

## 测试建议

### 测试步骤

1. **手动测试：**
   ```bash
   python futures_monitor.py
   ```
   运行两次，间隔5分钟，查看消息是否不同。

2. **检查时间戳：**
   确认Telegram消息显示的是完整时间（包含秒）。

3. **检查价格：**
   确认各品种状态中显示了价格。

4. **检查缓存：**
   查看日志，确认是否使用缓存数据：
   ```
   [ChinaFutures] 使用缓存数据: SA (4小时K线)
   [ChinaFutures] 获取成功 SA: 512 条4小时K线记录
   ```

---

## 总结

**问题：** 16:00和20:00推送的内容完全一样

**原因：**
1. 缓存时间过长（15分钟）
2. 时间显示不精确（只显示小时）
3. 各品种状态没有显示价格

**修复：**
1. 缩短缓存到5分钟
2. 显示完整时间（包含秒）
3. 各品种状态添加价格显示

**效果：**
- 每次推送都会显示不同的时间戳
- 每个品种显示当前价格
- 如果数据更新，内容会明显不同

---

**修复完成时间：** 2026-02-04 22:05
**修复状态：** ✅ 已完成
